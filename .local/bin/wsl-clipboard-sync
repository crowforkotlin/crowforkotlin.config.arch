#!/bin/bash

sleep 1

export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8

wl-paste -t "text/plain;charset=utf-8" --primary --watch bash -c 'iconv -c -f UTF-8 -t UTF-16LE | clip.exe' 2>/dev/null &
wl-paste -t "text/plain;charset=utf-8" --watch bash -c 'iconv -c -f UTF-8 -t UTF-16LE | clip.exe' 2>/dev/null &

last=""
while true; do
    current=$(timeout 2s powershell.exe -NoProfile -NonInteractive -Command \
        "[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; 
         Get-Clipboard -Raw" 2>/dev/null | tr -d '\r')
    
    if [[ -n "$current" && "$current" != "$last" ]]; then
        echo -n "$current" | wl-copy 2>/dev/null
        echo -n "$current" | wl-copy --primary 2>/dev/null
        last="$current"
    fi
    sleep 0.5
done
